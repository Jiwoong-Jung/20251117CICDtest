name: Build and Run Spring Boot in WSL

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted   # WSL Runner 사용
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set execute permission
        run: chmod +x ./gradlew

      - name: Ensure spring-app directory exists
        run: mkdir -p ~/spring-app && chmod -R 755 ~/spring-app

      - name: Build jar
        run: ./gradlew clean bootJar -x test

      - name: Run Spring Boot app
        run: |
          cp build/libs/*.jar ~/spring-app/app.jar
          chmod +x ~/spring-app/app.jar
          # 기존 java 프로세스 종료
          pkill -f 'java -jar ~/spring-app/app.jar' || true
          # 백그라운드로 안전하게 실행
          sudo java -jar ~/spring-app/app.jar > ~/spring-app/app.log 2>&1 < /dev/null &
