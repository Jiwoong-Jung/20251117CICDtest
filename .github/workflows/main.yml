name: Build and Run Spring Boot in WSL

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set execute permission for Gradle
        run: chmod +x ./gradlew

      - name: Ensure spring-app directory exists
        run: mkdir -p ~/spring-app && chmod -R 755 ~/spring-app

      - name: Build Spring Boot jar
        run: ./gradlew clean bootJar -x test

      - name: Run Spring Boot app
        run: |
          cp build/libs/*.jar ~/spring-app/app.jar
          chmod +x ~/spring-app/app.jar

          # 기존 프로세스 종료
          pkill -u $USER -f 'java -jar ~/spring-app/app.jar' || true

          # 로그 파일 초기화
          : > ~/spring-app/app.log

          # 백그라운드 실행 (WSL에서 안정적)
          setsid java -jar ~/spring-app/app.jar >> ~/spring-app/app.log 2>&1 < /dev/null &
          
          # 1초 대기 후 상태 확인
          sleep 1
          ps -ef | grep '[j]ava -jar ~/spring-app/app.jar'
          
      - name: Show app.log
        run: tail -n 20 ~/spring-app/app.log
